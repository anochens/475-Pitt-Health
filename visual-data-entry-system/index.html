<!DOCTYPE html>
<html>
	<head>
	<title>Health Resources</title>

	<meta name="viewport" content="width=device-width, initial-scale=1">

	<link rel="stylesheet" href="lib/jquery.mobile-1.0b3.min.css" />
	<script type="text/javascript" src="lib/jquery-1.6.3.min.js"></script>
	<script type="text/javascript" src="lib/jquery.mobile-1.0b3.min.js"></script>
	<script type="text/javascript" src="scripts/loadjson.js"></script>
	<script type="text/javascript" src="lib/jquery-ui.min.js"></script>
	<link rel="stylesheet" href="lib/ui.theme.css" type="text/css" media="all" />
	
	

	<style>
	.child {
	   margin-right:5px;
	   float:left;
	   width: 345px;
	   margin-left:2px;
	}
	#editItemButton{
		position: absolute;
		right: 30px;
		top: 5px;
	}
	#deleteItemButton{
		position: absolute;
		right: 65px;
		top: 5px;
	}	
	#editTitleButton{
		position: absolute;
		right: 30px;
		top: 5px;
	}	
	</style>
	
	<script>

	
	function transitionTo(pk, idPanel) {

		var res = getEntryFromFile(pk);

		if(res['type'] == 'MENU') {
			showMenu(idPanel, pk);
			makeMenu(res['items'], idPanel);
		}

		if(res['type'] == 'ENDPAGE') {
			showData(res['data'], idPanel, pk);
		}

		setTitle(res['title'], idPanel);
	}
	
	

	function setTitle(title, idPanel) {	
		$("[id='header-line']:eq("+idPanel+")").html(title);
		document.title = title;
	}

	function makeItemStatic(primarykey, elemId, newData) {
		var menuItem = $("#"+elemId);		
		var editButton = menuItem.find('#editItemButton');
		var deleteButton = menuItem.find('#deleteItemButton');

		menuItem = editButton.parent();
		menuItem.html(newData);
		menuItem.append(editButton);
		menuItem.append(deleteButton);
		
		editButton.unbind('click').click(function(e){
			makeItemEditable(e, primarykey, elemId);
		});
		
		deleteButton.unbind('click').click(function(e){
			deleteItem(e, primarykey, elemId);
		});		
		
		editButton.attr('src','./lib/images/pencil.PNG');

	}
	
	function saveItem(primarykey, elemId) {
		var newData = $("#"+elemId).find('#newItem').val();

		phpEditFunction(primarykey, newData, 'title');
		makeItemStatic(primarykey, elemId, newData);
		return false;
	}	
	
	function makeItemEditable(e, primarykey, elemId) {
		e.preventDefault();
		e.stopPropagation(); //make sure the item doesn't get clicked
		
 		var formData = "<form data-ajax='false' onsubmit='return saveItem("+primarykey+",\""+elemId+"\");'><input id='newItem' type='text' value='"+window.jsondata[primarykey]['title']+"' /></form>";

		var editButton = $("#"+elemId).find('#editItemButton');
		var deleteButton = $("#"+elemId).find('#deleteItemButton');
		
		var menuItem = editButton.parent();
		
		menuItem.html(formData);
		
		$('[id="newItem"]').click(function(e) {e.preventDefault();e.stopPropagation();});
		$('[id="newItem"]').keypress(function(e) {if(e.keyCode==13){e.preventDefault();e.stopPropagation();saveItem(primarykey,elemId)}});

		menuItem.append(editButton);
		menuItem.append(deleteButton);
		editButton.unbind('click').click(function(e){e.preventDefault();e.stopPropagation();saveItem(primarykey,elemId);});
		deleteButton.unbind('click').click(function(e) {deleteItem(e, primarykey, elemId)});
		editButton.attr('src','./lib/images/save-icon.JPG');
	}
	
	function deleteItem(e, primarykey, elemId) {
		e.preventDefault();
		e.stopPropagation(); //make sure the item doesn't get clicked
		
		var editButton = $("#"+elemId).find('#editItemButton');		
		var menuItem = editButton.parent();
		
		var doDelete = confirm("Are you sure you want to delete this item?\n("+window.jsondata[primarykey]['title']+")");
		
		if(doDelete) {
			phpDeleteFunction(primarykey);
			$("#"+elemId).hide();
		}
	}
	
	function phpDeleteFunction(pk){
		var url = 'deleteData.php';
		var data = { primarykey:pk };
		var request = $.ajax({
		  	async: false,
			type: 'POST',
		  	url: url,
		  	data: data,
		  	success: function(){
				alert("success");
				loadFile('data.json');
			},
		  	error: function(){
				alert("error");
			}
		});
	}
	
	function createMenuItem(elem, text, next, idPanel, primarykey) {
		var cloned = $(elem).clone();
		var ul = $("[id='main-menu']:eq("+idPanel+")");
		var editButton = '';
		var deleteButton = '';
		
		if(typeof primarykey != 'undefined') {
			editButton = "<img id='editItemButton' src='./lib/images/pencil.PNG'/>";
			deleteButton = "<img id='deleteItemButton' src='./lib/images/trash.PNG'/>";
		}
		
		var innerItem = cloned.find(':only-child:last');
		
		
		innerItem.html(text+editButton+deleteButton);
		innerItem.children().filter('#editItemButton').click(function(e) {makeItemEditable(e, primarykey, "to_"+next)});
		innerItem.children().filter('#deleteItemButton').click(function(e) {deleteItem(e, primarykey, "to_"+next)});

		innerItem.attr('next',next);
		cloned.attr('id', 'to_'+next);
		cloned.click(function() {
			ul.find('li').css('background','white');	
			$(cloned).css('background','yellow');	
			transitionTo(next, idPanel+1);
			
		});

		cloned.show();

		ul.append(cloned);
	}

	function emptyMenu(idPanel) {
		$("[id='main-menu']:eq("+idPanel+")").empty();
		$("[id='main-data']:eq("+idPanel+")").empty();
	}

	function emptyData(idPanel) {
		var classname = $(".child");
		for(var i = idPanel+1;i<classname.length;i++){
			$("[id='main-data']:eq("+i+")").empty();
			$("[id='firstColumn']:eq("+i+")").hide();			
		}
	}

	function hideMenu(idPanel) {
		emptyMenu(idPanel);
		$("[id='firstColumn']:eq("+idPanel+")").hide();
		$("[id='main-menu-wrapper']:eq("+idPanel+")").hide();
		
	}
	
	function phpAddNewItem(idPanel, pk, newTitle, radio){
		var url = 'addnewitem.php';
		var data = { primarykey:pk, radio_next_item:radio, title:newTitle};
		var request = $.ajax({
		  	async: false,
			type: 'POST',
		  	url: url,
		  	data: data,
		  	success: function(){
				alert("success");
			},
		  	error: function(){
				alert("error");
			},
		  	complete: function(){
				alert('completed');
		    },
		});
	}
	
	function phpAddExisting(idPanel, pk, newTitle, nextPk){
		console.log(nextPk);
		var url = 'addexisting.php';
		var data = { primarykey:pk, nextPK:nextPk, title:newTitle};
		var request = $.ajax({
		  	async: false,
			type: 'POST',
		  	url: url,
		  	data: data,
		  	success: function(){
				alert("success");
			},
		  	error: function(){
				alert("error");
			},
		  	complete: function(){
				alert('completed');
		    },
		});
	}
	
	function saveMenu(idPanel, primarykey, title, radio){
		if(typeof(primarykey) === 'undefined'){
			primarykey = 1;
		}
		console.log(typeof(radio));
		if(typeof(radio) === 'undefined'){
			var selectedItem;
			var txt = "";
			if(typeof(document.add_new_item.existing_menu.length)==='undefined'){
				selectedItem = $('[name="existing_endpage"] option:selected').val();
			}
			else if(typeof(document.add_new_item.existing_endpage.length)==='undefined'){
				selectedItem = $('[name="existing_menu"] option:selected').val();
			}
			console.log(selectedItem);
			phpAddExisting(idPanel, primarykey, title, selectedItem);
		}
		else{
			phpAddNewItem(idPanel, primarykey, title, radio);
		}
		loadFile('data.json');
		transitionTo(primarykey, idPanel); 
	}
	
	function showExistingMenu(){
		$('#existingItem').empty();
		var menuItems = getItems("MENU");
		var content = "<select name='existing_menu'>";
		for(var i in menuItems){
			content = content + "<option value="+menuItems[i].pk+">"+menuItems[i].title+"</option>";
		}
		content = content + "</select>";
		$('#existingItem').append(content);
		$('#existingItem').show();
	}
	
	function showExistingEndpage(){
		$('#existingItem').empty();
		var endpageItems = getItems("ENDPAGE");
		var content = "<select name='existing_endpage'>";
		for(var i in endpageItems){
			content = content + "<option value="+endpageItems[i].pk+">"+endpageItems[i].title+"</option>";
		}
		content = content + "</select>";
		$('#existingItem').append(content);
		$('#existingItem').show();
	}
	
	function dialogBox(idPanel, primarykey){
		document.add_new_item.reset();
		$('#existingItem').hide();
		$('[id="existing_menu"]').click(function(e) {e.preventDefault();e.stopPropagation();showExistingMenu();});
		$('[id="existing_endpage"]').click(function(e) {e.preventDefault();e.stopPropagation();showExistingEndpage();});
		
		$('#survey').dialog({
		autoOpen:true,
		//modal: true,
		maxWidth:250,
		resizable:false,
		draggable:false,
		title: "alan - Add new item",
		buttons: {
             "Submit Form": function() {
							var title = $('#title').val();
							var radio = $('input[name=radio_next_item]:checked').val();
							saveMenu(idPanel, primarykey, title, radio);
							$(this).dialog("close");
						 },
				 "Cancel": function() {
					  $(this).dialog("close");
             }
         },
		open: function(event, ui) { $(".ui-dialog-titlebar-close").hide(); }
		});

		$('[role="dialog"]').css('background','grey');
		$('[role="dialog"]').css('padding','5px');
		$('[role="dialog"]').css('min-height', '50px');
	}

	function showMenu(idPanel, primarykey) {
		$("[id='firstColumn']:eq("+idPanel+")").show();
		emptyMenu(idPanel);
		emptyData(idPanel);		
		$("[id='main-data']:eq("+idPanel+")").append("<button onclick='dialogBox("+idPanel+"," +primarykey + ")' id='popupButton'>Add New Item</button>")
		$("[id='main-menu-wrapper']:eq("+idPanel+")").show();
		$("[id='survey']:eq("+idPanel+")").hide();

		updateTitleButton(idPanel, primarykey);
	}

	function getTitleButton(idPanel, primarykey) {
		var titleparent=$("[id='header-line']:eq("+idPanel+")").parent();
		var titlebtn = titleparent.children().filter("[id='editTitleButton']");

		return titlebtn;
	}

	function updateTitleButton(idPanel, primarykey) {
		var titlebtn = getTitleButton(idPanel, primarykey);

		titlebtn.unbind('click').click(function() {makeTitleEditable(idPanel,primarykey)});
	}

	function makeTitleEditable(idPanel, primarykey) {
		var title = $("[id='header-line']:eq("+idPanel+")").html();

		var formData = "<form data-ajax='false' onsubmit='return saveTitle("+idPanel+","+primarykey+");'><input id='newTitle' type='text' value='"+title+"' /></form>";

		$("[id='header-line']:eq("+idPanel+")").html(formData);
		
		var titlebtn = getTitleButton(idPanel, primarykey)
		titlebtn.unbind('click').click(function() {saveTitle(idPanel,primarykey)});
		titlebtn.attr('src','./lib/images/save-icon.JPG');

	}

	function makeTitleStatic(idPanel, primarykey, title) {
		var title;
		
		if(typeof title == 'undefined') {
			title = window.jsondata[primarykey]['title'];
		}
		else {
			title = $("[id='newTitle']:eq(0)").val();
		}
		
		$("[id='header-line']:eq("+idPanel+")").html(title);
		
		var titlebtn = getTitleButton(idPanel, primarykey);
		titlebtn.unbind('click').click(function() {makeTitleEditable(idPanel,primarykey)});
		titlebtn.attr('src','./lib/images/pencil.PNG');
	}
	
	function phpEditFunction(pk, editData, type){
		var url = 'editData.php';
		var data = { primarykey:pk, editData:editData, type: type };
		var request = $.ajax({
		  	async: false,
			type: 'POST',
		  	url: url,
		  	data: data,
		  	success: function(){
				alert("success");
				if(window.jsondata[pk]) {
					window.jsondata[pk][type] = editData;
				}	
			},
		  	error: function(){
				alert("error");
			}
		});
	}

	function saveTitle(idPanel, primarykey) {
		var newTitle = $("[id='newTitle']:eq(0)").val();
		phpEditFunction(primarykey, newTitle, 'title');
		makeTitleStatic(idPanel, primarykey, newTitle);
		return false;
	}

	function saveData(idPanel, data, primarykey){
		var text = $('#testingTextArea').val();
		data = unescape(text);
		phpEditFunction(primarykey, data, 'data');
		emptyData(idPanel);
		showData(data, idPanel, primarykey);
	}
	
	function editData(idPanel, data, primarykey){
		data = unescape(data);
		$("#editButton").remove();
		$("[id='main-data']:eq("+idPanel+")").empty();
		var dataEntry = getEntryFromFile(primarykey);
		$("[id='main-data']:eq("+idPanel+")").append("<button onclick='saveData("+idPanel+",\""+escape(data)+"\","+primarykey+")' id='saveButton'>Save</button>");
		$("[id='main-data']:eq("+idPanel+")").append("<form><textarea rows='20' cols='35' id='testingTextArea' name='testingTextArea'>"+dataEntry.data+"</textarea></form>");
	}

	function showData(data, idPanel, primarykey) {
		emptyMenu(idPanel);
		$("[id='survey']:eq("+idPanel+")").hide();
		$("[id='firstColumn']:eq("+idPanel+")").show();
		var editVariables = "editData("+idPanel+",\""+escape(data)+"\","+primarykey+")";
		var editFunction = "<button onclick='"+editVariables+"' id='editButton'>Edit</button>";
		$("[id='main-menu']:eq("+idPanel+")").append(editFunction);
		$("[id='main-data']:eq("+idPanel+")").show();
		$("[id='main-data']:eq("+idPanel+")").html(data);
		addLinks(/[01]?[- .]?\(?[2-9]\d{2}\)?[- .]?\d{3}[- .]?\d{4}/g, true, 7);
		addLinks(/[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,6}/gi, false, true);
		addLinks(/(\bhttps?:\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gi);
		updateTitleButton(idPanel, primarykey);
	}
	

	//assume elem with pk 1 is the base menu
	function makeBaseMenu() {        
		var baseMenuPK = 1;
		var res = getEntryFromFile(baseMenuPK);
		makeMenu(res['items']);
	}

	function showBaseMenu() {
		transitionTo(1);
		window.back = [];
	}

	function makeMenu(items, idPanel, useSelfAsNext) {		
		var id;
		if(typeof idPanel==='undefined'){
			idPanel = 0;
			$('#firstColumn').clone().appendTo($('#firstColumn').parent()).hide();
		}
		else{
			$('#firstColumn').clone().appendTo($('#firstColumn').parent()).hide();
			$('#firstColumn').clone().appendTo($('#firstColumn').parent()).hide();
		}
		for(var i=0;i<items.length;i++) {
			itemdata = getEntryFromFile(items[i]);

			var next = itemdata['next'];
			if(typeof useSelfAsNext !== 'undefined') {
				next = itemdata['pk'];
			}
			// clone first column into second column
			// $("[id='base-item']:eq(0)"); first base item
			var test = $("[id='base-item']:eq("+idPanel+")");
			createMenuItem(test, itemdata['title'], next, idPanel, itemdata['pk']);
			
		}
	}
	
	function addLinks(regex, doLengthFiltering, isEmail, length) {
		var data = $("#main-data").html();
		var text = data.match(regex);
		if (text == null){
			return;
		}
		for (var i=0; i<text.length; i++){
			if (text[i] == null){
				continue;
			}
			if (isEmail == true){
				var emaillink = "<a href=\"mailto:"+text[i]+"\">"+text[i]+"</a>";	
				data = data.replace(text[i], emaillink);
			}	
			else if (doLengthFiltering == true){
				if (text[i].length >= 7){
					var tellink = "<a href=\"tel:"+text[i]+"\">"+text[i]+"</a>";	
					data = data.replace(new RegExp(text[i], 'g'), tellink);
				}
			}
			else {
				var link = "<a href=\""+text[i]+"\" target=\"_blank\">"+text[i]+"</a>";	
				data = data.replace(text[i], link);
			}
			for (var j=i+1; j<text.length; j++){
				if (text[j] == text[i]){
					text[j] = null;
				}
			}
		}
			
		$('#main-data').html(data);
	}

	</script>
	
</head>
<body>
	
<div data-role="page" data-theme="b">
	<div class='child' id="firstColumn">
	<div data-role="header" data-theme="b">
		<!-- <a href="" data-icon="back" id='back-button'>Back</a> -->
		<h1 id='header-line'>Health Resources</h1> 	
		<img id='editTitleButton' src='./lib/images/pencil.PNG'/>
	</div>

	<div data-role="content">
		<div id='main-menu-wrapper'>
			<ul data-role="listview" data-theme="c" data-filter="true" id='main-menu'>
				<li id='base-item' ><a href=""></a></li>
			</ul>
		</div>
		<style>
			pre {
				white-space: pre-wrap; /* css-3 */
				white-space: -moz-pre-wrap !important; /* Mozilla, since 1999 */
				white-space: -pre-wrap; /* Opera 4-6 */
				white-space: -o-pre-wrap; /* Opera 7 */
				word-wrap: break-word; /* Internet Explorer 5.5+ */
				
			}		
		</style>
		<br/>
		<br/>
		


		<pre style="font-family:arial;font-size:12pt;padding-right:20%">
			<div id='main-data'>
			</div>
		</pre>
	</div>	
	</div><!-- /content -->
	<div data-role="footer" data-theme="b" style='position:fixed;left:0px;bottom:0px;padding-bottom:5px;padding-top:5px'>&nbsp;
	</div>

 
</div><!-- /page -->
<div id="survey">
	<form id="add_new_item" name="add_new_item" method="post">
   <br/><strong>Title: </strong>
	<input id="title" type="text" name="title" value=""  />
   <br/><br/><strong>New Item</strong>
	<input id="menu" type="radio" name="radio_next_item" value="Menu"  />Menu
    <input id="endpage" type="radio" name="radio_next_item" value="Endpage"  />Endpage
	<button id="existing_menu" value="Existing Pages"> Connect to Existing Menu</button><br/>
	<button id="existing_endpage" value="Existing Pages"> Connect to Existing Endpage</button>
	
	<br/><br/>
	<div id="existingItem">
	</div>
    </form>	
</div>

<script>

$(document).ready(function() {
	$('#base-item').hide();
	makeBaseMenu();
	window.back = [];
	$("[id='main-data']:eq("+0+")").append("<button onclick='dialogBox("+0+")' id='popupButton'>Add New Item</button>");
	$("[id='survey']:eq("+0+")").hide();
	makeTitleStatic(0,1);
		
});


</script>

</body>
</html>
