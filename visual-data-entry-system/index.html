<!DOCTYPE html>
<html>
	<head>
	<title>Health Resources</title>

	<meta name="viewport" content="width=device-width, initial-scale=1">

	<link rel="stylesheet" href="lib/jquery.mobile-1.0b3.min.css" />
	<script type="text/javascript" src="lib/jquery-1.6.3.min.js"></script>
	<script type="text/javascript" src="lib/jquery.mobile-1.0b3.min.js"></script>
	<script type="text/javascript" src="scripts/loadjson.js"></script>
	<script type="text/javascript" src="lib/jquery-ui.min.js"></script>
	<link rel="stylesheet" href="lib/ui.theme.css" type="text/css" media="all" />
	
	

	<style>
	.child {
	   margin-right:5px;
	   float:left;
	   width: 345px;
	   margin-left:2px;
	}
	</style>
	
	<script>

	
	function transitionTo(pk, idPanel) {

		var res = getEntryFromFile(pk);
		window.currentPK = pk;

		if(res['type'] == 'MENU') {
			showMenu(idPanel, pk);
			makeMenu(res['items'], idPanel);
		}

		if(res['type'] == 'ENDPAGE') {
			showData(res['data'], idPanel, pk);
		}

		setTitle(res['title'], idPanel);
	}

	function setTitle(title, idPanel) {	
		$("[id='header-line']:eq("+idPanel+")").html(title);
		document.title = title;
	}

	function createMenuItem(elem, text, next, idPanel) {
		var cloned = $(elem).clone();
		var ul = $("[id='main-menu']:eq("+idPanel+")");

		cloned.find(':only-child:last').html(text);
		cloned.find(':only-child:last').attr('next',next);
		cloned.attr('id', 'to_'+next);
		cloned.click(function() {
			ul.find('li').css('background','white');	
			$(cloned).css('background','yellow');	
			transitionTo(next, idPanel+1);
			
		});

		cloned.show();

		ul.append(cloned);
	}

	function emptyMenu(idPanel) {
		$("[id='main-menu']:eq("+idPanel+")").empty();
		$("[id='main-data']:eq("+idPanel+")").empty();
	}

	function emptyData(idPanel) {
		var classname = $(".child");
		for(var i = idPanel+1;i<classname.length;i++){
			$("[id='main-data']:eq("+i+")").empty();
			$("[id='firstColumn']:eq("+i+")").hide();			
		}
	}

	function hideMenu(idPanel) {
		emptyMenu(idPanel);
		$("[id='firstColumn']:eq("+idPanel+")").hide();
		$("[id='main-menu-wrapper']:eq("+idPanel+")").hide();
		
	}
	
	function phpAddNewItem(idPanel, pk, newTitle, radio){
		console.log(newTitle);
		var url = 'addnewitem.php';
		var data = { primarykey:pk, radio_next_item:radio, title:newTitle};
		var request = $.ajax({
		  	async: false,
			type: 'POST',
		  	url: url,
		  	data: data,
		  	success: function(){
				alert("success");
			},
		  	error: function(){
				alert("error");
			},
		  	complete: function(){
				alert('completed');
		    },
		});
	}
	
	function saveMenu(idPanel, primarykey, title, radio){
		if(typeof(primarykey) === 'undefined'){
			primarykey = 1;
		}
		phpAddNewItem(idPanel, primarykey, title, radio);
		loadFile('data.json');
		transitionTo(primarykey, idPanel); 
	}
	
	function dialogBox(idPanel, primarykey){
		$('#survey').dialog({
		autoOpen:true,
		//modal: true,
		maxWidth:250,
		maxHeight:200,
		resizable:false,
		draggable:false,
		title: "alan - Add new item",
		buttons: {
             "Submit Form": function() {
							var title = $('#title').val();
							var radio = $('input[name=radio_next_item]:checked').val();
							saveMenu(idPanel, primarykey, title, radio);
							$(this).dialog("close");
						 },
				 "Cancel": function() {
					  $(this).dialog("close");
             }
         }
		});

		$('[role="dialog"]').css('background','grey');
		$('[role="dialog"]').css('padding','5px');
	}

	function showMenu(idPanel, primarykey) {
		$("[id='firstColumn']:eq("+idPanel+")").show();
		emptyMenu(idPanel);
		emptyData(idPanel);		
		$("[id='main-data']:eq("+idPanel+")").append("<button onclick='dialogBox("+idPanel+"," +primarykey + ")' id='popupButton'>Add New Item</button>")
		$("[id='main-menu-wrapper']:eq("+idPanel+")").show();
		$("[id='survey']:eq("+idPanel+")").hide();

		updateTitleButton(idPanel, primarykey);
	}

	function updateTitleButton(idPanel, primarykey) {
		$("[id='editTitleButton']:eq("+idPanel+")").unbind('click').click(function() {makeTitleEditable(idPanel,primarykey)});
	}

	function makeTitleEditable(idPanel, primarykey) {
		var title = $("[id='header-line']:eq("+idPanel+")").html();
		alert('current title is"'+title+'"');

		var formData = "<form data-ajax='false' onsubmit='return saveTitle("+idPanel+","+primarykey+");'><input id='newTitle' type='text' value='"+title+"' /></form>";

		$("[id='header-line']:eq("+idPanel+")").html(formData);
		$("[id='editTitleButton']:eq("+idPanel+")").unbind('click').click(function() {saveTitle(idPanel,primarykey)});
	}

	function makeTitleStatic(idPanel, primarykey, title) {
		var title = $("[id='newTitle']:eq(0)").val();
		$("[id='header-line']:eq("+idPanel+")").html(title);
		$("[id='editTitleButton']:eq("+idPanel+")").unbind('click').click(function() {makeTitleEditable(idPanel,primarykey)});
		loadFile('data.json');
	}
	
	function phpEditFunction(pk, editData, type){
		var url = 'editData.php';
		var data = { primarykey:pk, editData:editData, type: type };
		var request = $.ajax({
		  	async: false,
			type: 'POST',
		  	url: url,
		  	data: data,
		  	success: function(){
				alert("success");
			},
		  	error: function(){
				alert("error");
			},
		  	complete: function(a, b){
				alert('completed');
				console.log(a);
				console.log(b);
		    },
		});
	}

	function saveTitle(idPanel, primarykey) {
      var newTitle = $("[id='newTitle']:eq(0)").val();

		phpEditFunction(primarykey, newTitle, 'title');
		makeTitleStatic(idPanel, primarykey, newTitle);
		return false;
	}

	function saveData(idPanel, data, primarykey){
		var text = $('#testingTextArea').val();
		console.log(text);
		data = unescape(text);
		phpEditFunction(primarykey, data, 'data');
		loadFile('data.json');
		emptyData(idPanel);
		showData(data, idPanel, primarykey);
	}
	
	function editData(idPanel, data, primarykey){
		data = unescape(data);
		$("#editButton").remove();
		$("[id='main-data']:eq("+idPanel+")").empty();
		var dataEntry = getEntryFromFile(primarykey);
		$("[id='main-data']:eq("+idPanel+")").append("<button onclick='saveData("+idPanel+",\""+escape(data)+"\","+primarykey+")' id='saveButton'>Save</button>");
		$("[id='main-data']:eq("+idPanel+")").append("<form><textarea rows='20' cols='35' id='testingTextArea' name='testingTextArea'>"+dataEntry.data+"</textarea></form>");
	}

	function showData(data, idPanel, primarykey) {
		emptyMenu(idPanel);
		$("[id='survey']:eq("+idPanel+")").hide();
		$("[id='firstColumn']:eq("+idPanel+")").show();
		var editVariables = "editData("+idPanel+",\""+escape(data)+"\","+primarykey+")";
		var editFunction = "<button onclick='"+editVariables+"' id='editButton'>Edit</button>";
		$("[id='main-menu']:eq("+idPanel+")").append(editFunction);
		$("[id='main-data']:eq("+idPanel+")").show();
		$("[id='main-data']:eq("+idPanel+")").html(data);
		addLinks(/[01]?[- .]?\(?[2-9]\d{2}\)?[- .]?\d{3}[- .]?\d{4}/g, true, 7);
		addLinks(/[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,6}/gi, false, true);
		addLinks(/(\bhttps?:\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gi);
	}
	

	//assume elem with pk 1 is the base menu
	function makeBaseMenu() {        
		var baseMenuPK = 1;
		var res = getEntryFromFile(baseMenuPK);
		makeMenu(res['items']);
	}

	function showBaseMenu() {
		transitionTo(1);
		window.back = [];
	}

	function makeMenu(items, idPanel, useSelfAsNext) {		
		var id;
		if(typeof idPanel==='undefined'){
			idPanel = 0;

			$('#firstColumn').clone().appendTo($('#firstColumn').parent()).hide();
			$('#firstColumn').clone().appendTo($('#firstColumn').parent()).hide();
			$('#firstColumn').clone().appendTo($('#firstColumn').parent()).hide();
			
		}
		for(var i=0;i<items.length;i++) {
			itemdata = getEntryFromFile(items[i]);

			var next = itemdata['next'];
			if(typeof useSelfAsNext !== 'undefined') {
				next = itemdata['pk'];
			}
			// clone first column into second column
			// $("[id='base-item']:eq(0)"); first base item
			var test = $("[id='base-item']:eq("+idPanel+")");
			createMenuItem(test, itemdata['title'], next, idPanel);
			
		}
	}
	
	function addLinks(regex, doLengthFiltering, isEmail, length) {
		var data = $("#main-data").html();
		var text = data.match(regex);
		if (text == null){
			return;
		}
			for (var i=0; i<text.length; i++){
				if (text[i] == null){
					continue;
				}
				if (isEmail == true){
					var emaillink = "<a href=\"mailto:"+text[i]+"\">"+text[i]+"</a>";	
					data = data.replace(text[i], emaillink);
				}	
				else if (doLengthFiltering == true){
					if (text[i].length >= 7){
						var tellink = "<a href=\"tel:"+text[i]+"\">"+text[i]+"</a>";	
						data = data.replace(new RegExp(text[i], 'g'), tellink);
					}
				}
				else {
					var link = "<a href=\""+text[i]+"\" target=\"_blank\">"+text[i]+"</a>";	
					data = data.replace(text[i], link);
				}
			for (var j=i+1; j<text.length; j++){
				if (text[j] == text[i]){
					text[j] = null;
				}
			}
			}
			
		$('#main-data').html(data);
	}

	</script>
	
</head>
<body>
	
<div data-role="page" data-theme="b">
	<div class='child' id="firstColumn">
	<div data-role="header" data-theme="b">
		<!-- <a href="" data-icon="back" id='back-button'>Back</a> -->
		<h1 id='header-line'>Health Resources</h1> 
		
		<img id='editTitleButton' src='./lib/images/pencil.PNG'/>


		
	</div>

	<div data-role="content">
		<div id='main-menu-wrapper'>
		<ul data-role="listview" data-theme="c" data-filter="true" id='main-menu'>
			<li id='base-item' ><a href=""></a></li>
			
		</ul>
		</div>
		<style>
			pre {
				white-space: pre-wrap; /* css-3 */
				white-space: -moz-pre-wrap !important; /* Mozilla, since 1999 */
				white-space: -pre-wrap; /* Opera 4-6 */
				white-space: -o-pre-wrap; /* Opera 7 */
				word-wrap: break-word; /* Internet Explorer 5.5+ */
				
			}		
		</style>
		<br/>
		<br/>
		


		<pre style="font-family:arial;font-size:12pt;padding-right:20%">
			<div id='main-data'>
			</div>
		</pre>
	</div>	
	</div><!-- /content -->
	<div data-role="footer" data-theme="b" style='position:fixed;left:0px;bottom:0px;padding-bottom:5px;padding-top:5px'>&nbsp;
	</div>

 
</div><!-- /page -->
<div id="survey">
	<form id="add_new_item" name="add_new_item" method="post">
   <br/><strong>Title: </strong>
	<input id="title" type="text" name="title" value=""  />
   <br/><br/><strong>Next Item?</strong>
	<input id="menu" type="radio" name="radio_next_item" value="Menu"  />Menu
    <input id="endpage" type="radio" name="radio_next_item" value="Endpage"  />Endpage
    </form>	
</div>

<script>

$(document).ready(function() {
	$('#base-item').hide();
	makeBaseMenu();
	window.back = [];
	window.currentPK = 1;
	$("[id='main-data']:eq("+0+")").append("<button onclick='dialogBox("+0+")' id='popupButton'>Add New Item</button>");
	$("[id='survey']:eq("+0+")").hide();
	makeTitleStatic(0,0);
	
});


</script>

</body>
</html>
