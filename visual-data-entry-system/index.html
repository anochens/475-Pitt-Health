<!DOCTYPE html>
<html manifest="cache.manifest">
	<head>
	<title>Health Resources</title>

	<meta name="viewport" content="width=device-width, initial-scale=1">

	<link rel="stylesheet" href="lib/jquery.mobile-1.0b3.min.css" />
	<script type="text/javascript" src="lib/jquery-1.6.3.min.js"></script>
	<script type="text/javascript" src="lib/jquery.mobile-1.0b3.min.js"></script>
	<script type="text/javascript" src="lib/cookieFunctions.js"></script>
	<script type="text/javascript" src="scripts/loadjson.js"></script>
	<script type="text/javascript" src="scripts/bookmarkFunctions.js"></script>
	
	

	<style>
	.child {
	   margin-right:5px;
	   float:left;
	   width: 345px;
	   margin-left:2px;
	}
	</style>
	
	<script>

	
	function transitionTo(pk, from, idPanel) {

		var res = getEntryFromFile(pk);
		window.currentPK = pk;

		if(res['type'] == 'MENU') {
			showMenu(idPanel);
			makeMenu(res['items'], res['pk'], idPanel);
		}

		if(res['type'] == 'ENDPAGE') {
			//hideMenu(idPanel);
			showData(res['data'], idPanel);
			showToggleButton();
		}

		setTitle(res['title'], idPanel);

		if(typeof from !== 'undefined') {
			//setBack(from);
		}

	}

	function setTitle(title, idPanel) {
		idPanel += 1;
		$("[id='header-line']:eq("+idPanel+")").html(title);
		
		//$('#header-line').html(title);
		document.title = title;
	}

	function createMenuItem(elem, text, next, from, idPanel) {
		var cloned = $(elem).clone();
		var ul = $("[id='main-menu']:eq("+idPanel+")");
		//var ul = $('#main-menu');

		cloned.find(':only-child:last').html(text);
		cloned.find(':only-child:last').attr('next',next);
		cloned.attr('id', 'to_'+next);
		cloned.click(function() {
			ul.find('li').css('background','white');	
			$(cloned).css('background','yellow');	
			transitionTo(next, from, idPanel);
			
		});

		cloned.show();

		ul.append(cloned);
	}

	function emptyMenu(idPanel) {
		//$("[id^='to_']:eq("+idPanel+")").remove();
		//$('[id^="to_"]').remove()
		$("[id='main-menu']:eq("+idPanel+")").empty();
		
	}

	function emptyData(idPanel) {
		//$('#main-data').empty();
		var classname = $(".child");
		for(var i = idPanel+1;i<classname.length;i++){
			$("[id='main-data']:eq("+i+")").empty();
			$("[id='firstColumn']:eq("+i+")").hide();			
		}
		//$("[id='main-data']:eq("+idPanel+")").empty();
	}

	function hideMenu(idPanel) {
		emptyMenu(idPanel);
		//$('#main-menu-wrapper').hide();
		$("[id='firstColumn']:eq("+idPanel+")").hide();
		$("[id='main-menu-wrapper']:eq("+idPanel+")").hide();
		
	}

	function showMenu(idPanel) {
		idPanel += 1;
		$("[id='firstColumn']:eq("+idPanel+")").show();
		emptyMenu(idPanel);
		emptyData(idPanel);		
		
		$("[id='main-menu-wrapper']:eq("+idPanel+")").show();
		
	}
	
	function saveData(idPanel){
		alert("saved!");
		$('#saveButton').remove();
		$("[id='main-menu']:eq("+idPanel+")").append("<button onclick='editData("+idPanel+"') id='editButton'>Edit</button>");
		//$("[id='main-data']:eq("+idPanel+")");
	}
	
	function editData(idPanel, data){
		console.log(data);
		//$("[id='main-data']:eq("+idPanel+")").removeAttr('readOnly');
		$("#editButton").remove();
		$("[id='main-menu']:eq("+idPanel+")").append("<button onclick='saveData("+idPanel+"') id='saveButton'>Save</button>");
	}

	function showData(data, idPanel) {
		idPanel += 1;
		emptyMenu(idPanel);
		$("[id='firstColumn']:eq("+idPanel+")").show();
		// var testvariable = idPanel + "," + data;
		var testvariable = idPanel + "," + data;
		var editTest = "editData("+testvariable+")";
		var test = "<button onclick='"+editTest+"' id='editButton'>Edit</button>";
		console.log(test);
		// $("[id='main-menu']:eq("+idPanel+")").append("<button onclick='editData("+idPanel+","+data+")' id='editButton'>Edit</button>");
		$("[id='main-menu']:eq("+idPanel+")").append(test);
		$("[id='main-data']:eq("+idPanel+")").show();
		$("[id='main-data']:eq("+idPanel+")").html(data);
		//$('#main-data').html(data);
		addLinks(/[01]?[- .]?\(?[2-9]\d{2}\)?[- .]?\d{3}[- .]?\d{4}/g, true, 7);
		addLinks(/[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,6}/gi, false, true);
		addLinks(/(\bhttps?:\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gi);
	}
	

	//assume elem with pk 1 is the base menu
	function makeBaseMenu() {        
		var baseMenuPK = 1;
		var res = getEntryFromFile(baseMenuPK);
		makeMenu(res['items'], baseMenuPK);
	}

	function showBaseMenu() {
		transitionTo(1);
		window.back = [];
	}

	function makeMenu(items, from, idPanel, useSelfAsNext) {		
		var id;
		if(typeof idPanel==='undefined'){
			idPanel = 0;
			//CHANGE TO GENERIC FORM!!!
	 // $(".child:eq("+idPanel+")").clone().appendTo(".child:eq("+idPanel+1+")");
	
	// append to parent of first child
			
			// var classname=$('.child');
			// for(var i=1;i<classname.length;i++){
			// 	console.log(i);
			// 	$(".child:eq("+idPanel+")").clone().appendTo($(".child:eq("+idPanel+i+")"));
			// 	$(".child:eq("+idPanel+i+")").show();
			// }
			
			//$('#firstColumn').clone().appendTo($('#firstColumn').parent());

			// $('#firstColumn').clone().appendTo($('#firstColumn').parent());
			// 			$('#firstColumn').clone().appendTo($('#firstColumn').parent());
			// 			
			// $('#secondColumn').hide();
			// $('#thirdColumn').hide();
			// $('#fourthColumn').hide();

			$('#firstColumn').clone().appendTo($('#firstColumn').parent()).hide();
			$('#firstColumn').clone().appendTo($('#firstColumn').parent()).hide();
			$('#firstColumn').clone().appendTo($('#firstColumn').parent()).hide();
			
		}
		else{
			idPanel += 1;			
		}
		for(var i=0;i<items.length;i++) {
			itemdata = getEntryFromFile(items[i]);

			var next = itemdata['next'];
			if(typeof useSelfAsNext !== 'undefined') {
				next = itemdata['pk'];
			}
			// clone first column into second column
			// $("[id='base-item']:eq(0)"); first base item
			//createMenuItem($('#base-item'), itemdata['title'], next, from, id);
			var test = $("[id='base-item']:eq("+idPanel+")");
			createMenuItem(test, itemdata['title'], next, from, idPanel);
			
		}
	}
	
	function addLinks(regex, doLengthFiltering, isEmail, length) {
		var data = $("#main-data").html();
		var text = data.match(regex);
		if (text == null){
			return;
		}
			for (var i=0; i<text.length; i++){
				if (text[i] == null){
					continue;
				}
				if (isEmail == true){
					var emaillink = "<a href=\"mailto:"+text[i]+"\">"+text[i]+"</a>";	
					data = data.replace(text[i], emaillink);
				}	
				else if (doLengthFiltering == true){
					if (text[i].length >= 7){
						var tellink = "<a href=\"tel:"+text[i]+"\">"+text[i]+"</a>";	
						data = data.replace(new RegExp(text[i], 'g'), tellink);
					}
				}
				else {
					var link = "<a href=\""+text[i]+"\" target=\"_blank\">"+text[i]+"</a>";	
					data = data.replace(text[i], link);
				}
			for (var j=i+1; j<text.length; j++){
				if (text[j] == text[i]){
					text[j] = null;
				}
			}
			}
			
		$('#main-data').html(data);
	}

	</script>
</head>
<body>
<div data-role="page" data-theme="b">
	<div class='child' id="firstColumn">
	<div data-role="header" data-theme="b">
		<!-- <a href="" data-icon="back" id='back-button'>Back</a> -->
		<h1 id='header-line'>Health Resources</h1>
	</div>

	<div data-role="content">
		<div id='main-menu-wrapper'>
		<ul data-role="listview" data-theme="c" data-filter="true" id='main-menu'>
			<li id='base-item' ><a href=""></a></li>
			
		</ul>
		</div>
		<style>
			pre {
				white-space: pre-wrap; /* css-3 */
				white-space: -moz-pre-wrap !important; /* Mozilla, since 1999 */
				white-space: -pre-wrap; /* Opera 4-6 */
				white-space: -o-pre-wrap; /* Opera 7 */
				word-wrap: break-word; /* Internet Explorer 5.5+ */
				
			}		
		</style>
		<br/>
		<br/>
		
		<pre style="font-family:arial;font-size:12pt;padding-right:20%">
			<div id='main-data'>
			</div>
			<!-- <form name=myform>
			<textarea name='mytextarea' cols='13' rows='13' readonly=true id='main-data'>
			This is a text area ...........
			</textarea>
			</form> -->
		</pre>
	</div>	
	</div><!-- /content -->
	<div data-role="footer" data-theme="b" style='position:fixed;left:0px;bottom:0px;padding-bottom:5px;padding-top:5px'>&nbsp;
		<!-- <a href="" data-icon="home" id='home-button' onclick='showBaseMenu();'>Home</a> -->
	</div>

 
</div><!-- /page -->

<script>

$(document).ready(function() {
	$('#base-item').hide();
	makeBaseMenu();
	window.back = [];
	window.currentPK = 1;
});

</script>

</body>
</html>
