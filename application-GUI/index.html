<!DOCTYPE html>
<html manifest="cache.manifest">
	<head>
	<title>Health Resources</title>

	<meta name="viewport" content="width=device-width, initial-scale=1">

	<link rel="stylesheet" href="lib/jquery.mobile-1.0b3.min.css" />
	<script type="text/javascript" src="lib/jquery-1.6.3.min.js"></script>
	<script type="text/javascript" src="lib/jquery.mobile-1.0b3.min.js"></script>
	<script type="text/javascript" src="lib/cookieFunctions.js"></script>
	<script type="text/javascript" src="scripts/loadjson.js"></script>
	<script type="text/javascript" src="scripts/bookmarkFunctions.js"></script>
	<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.16/jquery-ui.min.js"></script>
	<link rel="stylesheet" href="lib/ui.theme.css" type="text/css" media="all" />
		<script>
	$(function() {
		var availableTags = returnTitles();
		console.log(availableTags);
		$( "#tags" ).autocomplete({
			source: availableTags
		});
	});
	</script>
	<script>
	function setBack(pk) {
		window.back.push(pk);
		$('#back-button').show();
		$('#home-button').show();
		$('#back-button').unbind('click').click(function (){
			goBack();
		});
	}

	function goBack() {
		var last = window.back.pop();

		//if we are on the root page, hide the back button
		if(back.length == 0) {
			$('#back-button').hide();
			$('#home-button').hide();
		}

		if(last == 0) {
			$('#bookmarks-button').hide();
			showBookmarks();
		}
		else {
			transitionTo(last);
		}
	}
	
	function transitionTo(pk, from) {
		$('#bookmarks-button').show();
		$('#email-button').hide();
		$('#sms-button').hide();
		var res = getEntryFromFile(pk);
		window.currentPK = pk;
		setTitle(res['title']);
		if(res['type'] == 'MENU') {
			showMenu();
			makeMenu(res['items'], res['pk']);
		}
		$('#add-bookmark-button').hide();

		if(res['type'] == 'ENDPAGE') {
			hideMenu();
			showData(res['data']);
			showToggleButton();
		}
		if(typeof from !== 'undefined') {
			setBack(from);
		}

	}

	function setTitle(title) {
		$('#header-line').html(title);
		document.title = title;
	}

	function createMenuItem(elem, text, next, from) {
		var cloned = $(elem).clone();
		var ul = $('#main-menu');

		cloned.find(':only-child:last').html(text);
		cloned.find(':only-child:last').attr('next',next);
		cloned.attr('id', 'to_'+next);
		cloned.click(function() {
			transitionTo(next, from)
		});

		cloned.show();

		ul.append(cloned);
	}

	function emptyMenu() {
		$('[id^="to_"]').remove()
	}

	function emptyData() {
		$('#main-data').empty();
	}

	function hideMenu() {
		emptyMenu();
		$('#main-menu-wrapper').hide();
	}

	function showMenu() {
		emptyMenu();
		emptyData();
		$('#main-menu-wrapper').show();
	}

	function showData(data) {
		$('#main-data').html(data);
		showMailerButton();
		showSMSButton();
		addLinks(/[01]?[- .]?\(?[2-9]\d{2}\)?[- .]?\d{3}[- .]?\d{4}/g, true, 7);
		addLinks(/[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,6}/gi, false, true);
		addLinks(/(\bhttps?:\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gi);
	}

	//assume elem with pk 1 is the base menu
	function makeBaseMenu() {
		var baseMenuPK = 1;
		var res = getEntryFromFile(baseMenuPK);
		makeMenu(res['items'], baseMenuPK);
	}

	function showBaseMenu() {
		transitionTo(1);
		window.back = [];
		$('#back-button').hide();
		$('#home-button').hide();
	}

	function makeMenu(items, from, useSelfAsNext) {
		console.log("yay");
		for(var i=0;i<items.length;i++) {
			itemdata = getEntryFromFile(items[i]);
			console.log(next);
			var next = itemdata['next'];
			var title=itemdata['title'];
			if(typeof useSelfAsNext !== 'undefined') {
				next = itemdata['pk'];
				console.log(next);
				console.log(useSelfAsNext[i]);
				title=itemdata['title']+"<br>"+itemdata['data'].substring(0, useSelfAsNext[i]);
			}

			createMenuItem($('#base-item'), title, next, from);
		}
	}
	
	function addLinks(regex, doLengthFiltering, isEmail, length) {
		var data = $("#main-data").html();
		var text = data.match(regex);
		if (text == null){
			return;
		}
			for (var i=0; i<text.length; i++){
				if (text[i] == null){
					continue;
				}
				if (isEmail == true){
					var emaillink = "<a href=\"mailto:"+text[i]+"\">"+text[i]+"</a>";	
					data = data.replace(text[i], emaillink);
				}	
				else if (doLengthFiltering == true){
					if (text[i].length >= 7){
						var tellink = "<a href=\"tel:"+text[i]+"\">"+text[i]+"</a>";	
						data = data.replace(new RegExp(text[i], 'g'), tellink);
					}
				}
				else {
					var link = "<a href=\""+text[i]+"\" target=\"_blank\">"+text[i]+"</a>";	
					data = data.replace(text[i], link);
				}
			for (var j=i+1; j<text.length; j++){
				if (text[j] == text[i]){
					text[j] = null;
				}
			}
			}
			
		$('#main-data').html(data);
	}

	function showMailerButton(){
		var data = $("#main-data").html();
		$('#email-button').show();
		$('#email-button').attr("href", "mailto:?subject="+encodeURIComponent(document.title)+"&body=" + encodeURIComponent(data));
	}
	
	function showSMSButton(){
		var message = $("#main-data").html();
		var shorttext;
		$('#sms-button').show();
		$.ajax({
		  type: 'POST',
		  url: "http://shorttext.com/default.aspx",
		  data: {txtMaal: encodeURIComponent(message)},
		  success: function(data){
			shorttext = data
		},
			async: false
		});
		console.log(shorttext);
		$('#sms-button').attr("href", "sms:?body=" +body);
	}
			
	function search() {
	var searchValue=$('#search').val();
	var availableTags = returnTitles();
	var pks=[];
	var indexes=[];
	 $.each(availableTags, function(i,v) {
				var title=v.title;
				var pk=v.pk;
				var data=v.data;
				var type=v.type;
				if(type=="ENDPAGE"){
				if(title.indexOf(searchValue)>=0||data.indexOf(searchValue)>=0){
               			 console.log(pk);
						 pks.push(pk);
						 }
				}
            });
			 if(pks.length==1){
							console.log(pks[0])
							var res = getEntryFromFile(pks[0]);
							hideMenu();
							showData(res['data']);
							showToggleButton();
			}
			if(pks.length>1){
					showMenu();
					makeMenu(pks, 1, indexes);
			}
	}

	</script>
</head>
<body>
<div data-role="page" data-theme="b">
	<div data-role="header" data-theme="b">
		<a href="" data-icon="back" id='back-button'>Back</a>
			<a href="" id='add-bookmark-button' onclick='toggleBookmark();'>Toggle bookmark</a>
		<h1 id='header-line'>Health Resources</h1>
	</div>

	<div data-role="content">
		<div style="padding-bottom:20px;">
       	        <input type="search" name="search" id="search"> <input type="submit" value="Search" onclick="search();">
		</div>
		<div id='main-menu-wrapper'>
		<ul data-role="listview" data-theme="c"  id='main-menu'>
			<li id='base-item' ><a href=""></a></li>
		</ul>
		</div>
		<style>
			pre {
				white-space: pre-wrap; /* css-3 */
				white-space: -moz-pre-wrap !important; /* Mozilla, since 1999 */
				white-space: -pre-wrap; /* Opera 4-6 */
				white-space: -o-pre-wrap; /* Opera 7 */
				word-wrap: break-word; /* Internet Explorer 5.5+ */
				
			}		
		</style>
		
		
		<pre style="font-family:arial;
				font-size:12pt;padding-right:20%">
				<div id='main-data'>
					
				</div></pre>
				
	</div><!-- /content -->

	<div data-role="footer" data-theme="b" style='position:fixed;left:0px;bottom:0px;padding-bottom:5px;padding-top:5px'>&nbsp;
		<a href="" data-icon="home" id='home-button' onclick='showBaseMenu();'>Home</a>
		<a href="" id='bookmarks-button' onclick='showBookmarks();'>Bookmarks</a>
		<a href="" data-icon="arrow-r" id='email-button'>Email</a>
		<a href="" data-icon="arrow-r" id='sms-button'>Text This</a>
	</div>
 
</div><!-- /page -->

<script>

$(document).ready(function() {
	$('#back-button').hide();
	$('#home-button').hide();
	$('#base-item').hide();
	$('#add-bookmark-button').hide();
	$('#email-button').hide();
	$('#sms-button').hide();
	makeBaseMenu();
	window.back = [];
	window.currentPK = 1;
});

</script>

</body>
</html>
